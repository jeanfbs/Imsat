var started=false;var salto_coluna=0;var salto_linha=0;var interval;var map;var l=0;var c=0;
$(document).ready(function(){initialize();$("#extrair").on("click",function(){started=true;$("#pbar").attr("valuenow",0);$("#pbar").width("0%");$("#resultado").empty();localStorage.setItem("tempDir",(new Date).getTime());var par={};par.lat1=parseFloat($("#lat_start").val());par.lng1=parseFloat($("#long_start").val());par.lat2=parseFloat($("#lat_end").val());par.lng2=parseFloat($("#long_end").val());par.zoom=parseInt($("#zoom").val(),10);resolveCordinate(par)});$("#cancel").on("click",function(){clearInterval(interval);
started=false;$("#pbar").attr("valuenow",0);$("#pbar").width("0%");alertSucesso("A extra\u00e7\u00e3o foi cancelada!")});$("#atualizar").on("click",function(){var par={};if(parseInt($("input[name=auto]:checked").val(),10)==1){par.lat1=parseFloat($("#lat_start").val());par.lng1=parseFloat($("#long_start").val())}else{par.lat1=parseFloat($("#lat_end").val());par.lng1=parseFloat($("#long_end").val())}par.zoom=parseInt($("#zoom").val(),10);update(par.lat1,par.lng1,par.zoom)});google.maps.event.addListener(map,
"tilesloaded",function(){if(started)printMap(l,c)});google.maps.event.addListener(map,"drag",function(){split=map.getCenter().toString().replace("(","").split(",");lat=parseFloat(split[0]);lng=parseFloat(split[1]);if(parseInt($("input[name=auto]:checked").val(),10)==1){$("#lat_start").val(lat.toFixed(4));$("#long_start").val(lng.toFixed(4))}else{$("#lat_end").val(lat.toFixed(4));$("#long_end").val(lng.toFixed(4))}})});
function download_image(linha,coluna,canvas){var fileName="l_"+linha+"_c_"+coluna+".png";var col_md_1=$("<div></div>");col_md_1.addClass("col-md-2");$.ajax({type:"POST",async:false,url:$("#form").attr("baseurl")+"/image",data:{nome:fileName,image:canvas.toDataURL("image/png"),dir:localStorage.getItem("tempDir")}});var link=$("<a></a>");link.prop("download",fileName);link.prop("href",canvas.toDataURL("image/png").replace("image/png","image/octet-stream"));link.text("Linha "+linha+" Coluna "+coluna);
col_md_1.append(link);$("#resultado").append(col_md_1)}function printMap(linha,coluna){html2canvas([$("#map")[0]],{logging:false,useCORS:true,onrendered:function(canvas){download_image(linha,coluna,canvas)}})}function initialize(){var mapProp={center:new google.maps.LatLng(-18.9,-48.24),zoom:18,disableDefaultUI:true,mapTypeId:google.maps.MapTypeId.SATELLITE};map=new google.maps.Map(document.getElementById("map"),mapProp)}
function update(lat,lng,zoom){latlng=new google.maps.LatLng(lat,lng);map.setZoom(zoom);map.setCenter(latlng)}
function resolveCordinate(par){var DLAT=0;var DLNG=0;var timeRepeat=0;if(par.zoom==19){DLAT=.00127;DLNG=.00135;timeRepeat=2500}else if(par.zoom==18){DLAT=.00254;DLNG=.0027;timeRepeat=2050}else if(par.zoom==17){DLAT=.00508;DLNG=.0054;timeRepeat=1800}else if(par.zoom==16){DLAT=.0101;DLNG=.0108;timeRepeat=1700}salto_coluna=parseInt(Math.ceil(Math.abs(par.lng2-par.lng1)/DLNG),10);salto_linha=parseInt(Math.ceil(Math.abs(par.lat2-par.lat1)/DLAT),10);if(salto_coluna==0)salto_coluna=1;if(salto_linha==0)salto_linha=
1;var inc=parseFloat(100/(salto_coluna*salto_linha));var lat_aux=0;var lng_aux=0;switch(getQuadrante(par)){case 1:console.log("Quandrante 1");break;case 2:console.log("Quandrante 2");break;case 3:console.log("Quandrante 3");transporXY(par);lat_aux=par.lat1;lng_aux=par.lng1;var i=0;var j=0;interval=setInterval(function(){if(i==salto_linha){clearInterval(interval);started=false;$("#modal_status").modal("hide");$("#pbar").attr("valuenow",100);$("#pbar").width("100%");$("#resultado").prepend("<div class='col-md-2'><a href='"+
$("#form").attr("baseurl")+"/temp/"+localStorage.getItem("tempDir")+".zip' download>Baixar Zip</a></div>");return started}if(j>-1&&j<salto_coluna){update(lat_aux,lng_aux,par.zoom);l=i;c=j;value=parseFloat($("#pbar").attr("valuenow"))+inc;$("#pbar").attr("valuenow",value);$("#pbar").width(value+"%");if(par.lng1!=par.lng2)if(par.lng1<par.lng2)lng_aux+=DLNG;else lng_aux-=DLNG}j++;if(j==salto_coluna){lng_aux=par.lng1;if(par.lat1!=par.lat2)if(par.lat1<par.lat2)lat_aux+=DLAT;else lat_aux-=DLAT;j=0;i++}},
timeRepeat);break;case 4:console.log("Quandrante 4");break;default:console.log("%cErro: A dist\u00e2ncia das coordenadas de mapeamento \u00e9 muito grande","color:red")}}
function transporXY(par){if(par.lat1<par.lat2&&par.lng1>par.lng2){aux=par.lat1;par.lat1=par.lat2;par.lat2=aux;aux=par.lng1;par.lng1=par.lng2;par.lng2=aux}else if(par.lat1<par.lat2&&par.lng1<par.lng2){aux=par.lat1;par.lat1=par.lat2;par.lat2=aux}else if(par.lat1>par.lat2&&par.lng1>par.lng2){tmp=par.lng1;par.lng1=par.lng2;par.lng2=tmp}}
function getQuadrante(par){if(par.lat1>0&&par.lng1>0&&par.lat2>0&&par.lng2>0)return 1;else if(par.lat1>0&&par.lng1<0&&par.lat2>0&&par.lng2<0)return 2;else if(par.lat1<0&&par.lng1<0&&par.lat2<0&&par.lng2<0)return 3;else if(par.lat1<0&&par.lng1>0&&par.lat2<0&&par.lng2>0)return 4;else return 0};